schema: '2.0'
stages:
  save-existing-reports:
    cmd:
    - touch data/raw/nuforc_reports.json
    - cp data/raw/nuforc_reports.json data/raw/nuforc_reports_orig.json
    outs:
    - path: data/raw/nuforc_reports_orig.json
      md5: 50e3f0b6dd1ba5f195111251fb78ecd6
      size: 224216951
  unzip-cities:
    cmd:
    - unzip -o data/external/GeoLite2-City-CSV.zip -d data/external/
    - rm -rf data/external/geolite_city
    - mv -f data/external/GeoLite2-City-CSV_* data/external/geolite_city
    deps:
    - path: data/external/GeoLite2-City-CSV.zip
      md5: 3601f8883d41a00d942da37761bf074b
      size: 52253606
    outs:
    - path: data/external/geolite_city/GeoLite2-City-Blocks-IPv4.csv
      md5: fd725d11d9197f82f129e42fb9dafa46
      size: 236317242
    - path: data/external/geolite_city/GeoLite2-City-Locations-en.csv
      md5: 919074fc3f469f308bab55864dcbecdf
      size: 10036739
  make-cities:
    cmd:
    - python scripts/make_cities.py data/external/geolite_city/GeoLite2-City-Locations-en.csv
      data/external/geolite_city/GeoLite2-City-Blocks-IPv4.csv --output-file data/external/cities.csv
    deps:
    - path: data/external/geolite_city/GeoLite2-City-Blocks-IPv4.csv
      md5: fd725d11d9197f82f129e42fb9dafa46
      size: 236317242
    - path: data/external/geolite_city/GeoLite2-City-Locations-en.csv
      md5: 919074fc3f469f308bab55864dcbecdf
      size: 10036739
    - path: scripts/make_cities.py
      md5: f46af8dbf6a3b8142be74a2584b001fe
      size: 1217
    outs:
    - path: data/external/cities.csv
      md5: 281a08db9042f5f9d28b73e559edc557
      size: 6318782
  pull-new-reports:
    cmd:
    - cd nuforc_reports && scrapy crawl nuforc_report_spider --output $(dvc root)/data/raw/nuforc_reports_new.json
      --output-format jsonlines
    outs:
    - path: data/raw/nuforc_reports_new.json
      md5: bc43471dc2c83cc3a1daba65d94a29b0
      size: 227239377
  merge-reports:
    cmd:
    - python scripts/union_nuforc_reports.py data/raw/nuforc_reports_orig.json data/raw/nuforc_reports_new.json
      data/raw/nuforc_reports.json
    deps:
    - path: data/raw/nuforc_reports_new.json
      md5: bc43471dc2c83cc3a1daba65d94a29b0
      size: 227239377
    - path: data/raw/nuforc_reports_orig.json
      md5: 50e3f0b6dd1ba5f195111251fb78ecd6
      size: 224216951
    - path: scripts/union_nuforc_reports.py
      md5: d14437b7531198ddf7e12cbd61929450
      size: 1130
    outs:
    - path: data/raw/nuforc_reports.json
      md5: 1af992b742605ec386c813830bb4622c
      size: 227243380
  geocode-reports:
    cmd:
    - python scripts/process_report_data.py data/raw/nuforc_reports.json data/external/cities.csv
      --output-file data/processed/nuforc_reports.csv
    deps:
    - path: data/external/cities.csv
      md5: 281a08db9042f5f9d28b73e559edc557
      size: 6318782
    - path: data/raw/nuforc_reports.json
      md5: 1af992b742605ec386c813830bb4622c
      size: 227243380
    - path: scripts/process_report_data.py
      md5: 03fd59b015bf15dea56ea4270ae835bb
      size: 7717
    outs:
    - path: data/processed/nuforc_reports.csv
      md5: 962c102ef62bb8ec6a7adaf8be07f583
      size: 211442749
