schema: '2.0'
stages:
  save-existing-reports:
    cmd:
    - touch data/raw/nuforc_reports.json
    - cp data/raw/nuforc_reports.json data/raw/nuforc_reports_orig.json
    outs:
    - path: data/raw/nuforc_reports_orig.json
      hash: md5
      md5: d41d8cd98f00b204e9800998ecf8427e
      size: 0
  unzip-cities:
    cmd:
    - unzip -o data/external/GeoLite2-City-CSV.zip -d data/external/
    - rm -rf data/external/geolite_city
    - mv -f data/external/GeoLite2-City-CSV_* data/external/geolite_city
    deps:
    - path: data/external/GeoLite2-City-CSV.zip
      hash: md5
      md5: 75c200d1d25ff734c0f3e760ffc4dc13
      size: 53499758
    outs:
    - path: data/external/geolite_city/GeoLite2-City-Blocks-IPv4.csv
      hash: md5
      md5: 4364dd2b41bce807d09812a2d688f43e
      size: 232519664
    - path: data/external/geolite_city/GeoLite2-City-Locations-en.csv
      hash: md5
      md5: 34fbddc007df00f135de95d71cf92025
      size: 10242394
  make-cities:
    cmd:
    - python scripts/make_cities.py data/external/geolite_city/GeoLite2-City-Locations-en.csv
      data/external/geolite_city/GeoLite2-City-Blocks-IPv4.csv --output-file data/external/cities.csv
    deps:
    - path: data/external/geolite_city/GeoLite2-City-Blocks-IPv4.csv
      hash: md5
      md5: 4364dd2b41bce807d09812a2d688f43e
      size: 232519664
    - path: data/external/geolite_city/GeoLite2-City-Locations-en.csv
      hash: md5
      md5: 34fbddc007df00f135de95d71cf92025
      size: 10242394
    - path: scripts/make_cities.py
      md5: f46af8dbf6a3b8142be74a2584b001fe
      size: 1217
    outs:
    - path: data/external/cities.csv
      hash: md5
      md5: fe1fa97bdf8d3f4c6859c1aebb12cef7
      size: 6484862
  pull-new-reports:
    cmd:
    - cd nuforc_reports && scrapy crawl nuforc_report_spider --output $(dvc root)/data/raw/nuforc_reports_new.json
      --output-format jsonlines
    outs:
    - path: data/raw/nuforc_reports_new.json
      hash: md5
      md5: fb6708d54ddf87a4282b7b9160031da4
      size: 85756101
  merge-reports:
    cmd:
    - python scripts/union_nuforc_reports.py data/raw/nuforc_reports_orig.json data/raw/nuforc_reports_new.json
      data/raw/nuforc_reports.json
    deps:
    - path: data/raw/nuforc_reports_new.json
      hash: md5
      md5: fb6708d54ddf87a4282b7b9160031da4
      size: 85756101
    - path: data/raw/nuforc_reports_orig.json
      hash: md5
      md5: d41d8cd98f00b204e9800998ecf8427e
      size: 0
    - path: scripts/union_nuforc_reports.py
      md5: d14437b7531198ddf7e12cbd61929450
      size: 1130
    outs:
    - path: data/raw/nuforc_reports.json
      hash: md5
      md5: fb6708d54ddf87a4282b7b9160031da4
      size: 85756101
  geocode-reports:
    cmd:
    - python scripts/process_report_data.py data/raw/nuforc_reports.json data/external/cities.csv
      --output-file data/processed/nuforc_reports.csv
    deps:
    - path: data/external/cities.csv
      hash: md5
      md5: fe1fa97bdf8d3f4c6859c1aebb12cef7
      size: 6484862
    - path: data/raw/nuforc_reports.json
      hash: md5
      md5: fb6708d54ddf87a4282b7b9160031da4
      size: 85756101
    - path: scripts/process_report_data.py
      md5: 03fd59b015bf15dea56ea4270ae835bb
      size: 7717
    outs:
    - path: data/processed/nuforc_reports.csv
      hash: md5
      md5: 254e63f4c77aaf7b9eefdcd819d39888
      size: 77565215
