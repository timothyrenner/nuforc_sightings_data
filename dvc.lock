schema: '2.0'
stages:
  save-existing-reports:
    cmd:
    - touch data/raw/nuforc_reports.json
    - cp data/raw/nuforc_reports.json data/raw/nuforc_reports_orig.json
    outs:
    - path: data/raw/nuforc_reports_orig.json
      md5: 56039b24b50b22bfb030a6a075c731b6
      size: 219661245
  unzip-cities:
    cmd:
    - unzip -o data/external/GeoLite2-City-CSV.zip -d data/external/
    - rm -rf data/external/geolite_city
    - mv -f data/external/GeoLite2-City-CSV_* data/external/geolite_city
    deps:
    - path: data/external/GeoLite2-City-CSV.zip
      md5: 2f97146b0988a2ec5173e5760816dfb8
      size: 50285930
    outs:
    - path: data/external/geolite_city/GeoLite2-City-Blocks-IPv4.csv
      md5: 3d318c442192378530b2abef39394fe6
      size: 225187559
    - path: data/external/geolite_city/GeoLite2-City-Locations-en.csv
      md5: d4a62e2613bbd84b91e2cf8a4483f92d
      size: 10500345
  make-cities:
    cmd:
    - python scripts/make_cities.py data/external/geolite_city/GeoLite2-City-Locations-en.csv
      data/external/geolite_city/GeoLite2-City-Blocks-IPv4.csv --output-file data/external/cities.csv
    deps:
    - path: data/external/geolite_city/GeoLite2-City-Blocks-IPv4.csv
      md5: 3d318c442192378530b2abef39394fe6
      size: 225187559
    - path: data/external/geolite_city/GeoLite2-City-Locations-en.csv
      md5: d4a62e2613bbd84b91e2cf8a4483f92d
      size: 10500345
    - path: scripts/make_cities.py
      md5: f46af8dbf6a3b8142be74a2584b001fe
      size: 1217
    outs:
    - path: data/external/cities.csv
      md5: 86c9047b80e68102fc8d19376b7b4c22
      size: 6570447
  pull-new-reports:
    cmd:
    - cd nuforc_reports && scrapy crawl nuforc_report_spider --output $(dvc root)/data/raw/nuforc_reports_new.json
      --output-format jsonlines
    outs:
    - path: data/raw/nuforc_reports_new.json
      md5: 008eb3929e866d62dc34a0e4a61b32d6
      size: 224213664
  merge-reports:
    cmd:
    - python scripts/union_nuforc_reports.py data/raw/nuforc_reports_orig.json data/raw/nuforc_reports_new.json
      data/raw/nuforc_reports.json
    deps:
    - path: data/raw/nuforc_reports_new.json
      md5: 008eb3929e866d62dc34a0e4a61b32d6
      size: 224213664
    - path: data/raw/nuforc_reports_orig.json
      md5: 56039b24b50b22bfb030a6a075c731b6
      size: 219661245
    - path: scripts/union_nuforc_reports.py
      md5: d14437b7531198ddf7e12cbd61929450
      size: 1130
    outs:
    - path: data/raw/nuforc_reports.json
      md5: 50e3f0b6dd1ba5f195111251fb78ecd6
      size: 224216951
  geocode-reports:
    cmd:
    - python scripts/process_report_data.py data/raw/nuforc_reports.json data/external/cities.csv
      --output-file data/processed/nuforc_reports.csv
    deps:
    - path: data/external/cities.csv
      md5: 86c9047b80e68102fc8d19376b7b4c22
      size: 6570447
    - path: data/raw/nuforc_reports.json
      md5: 50e3f0b6dd1ba5f195111251fb78ecd6
      size: 224216951
    - path: scripts/process_report_data.py
      md5: 03fd59b015bf15dea56ea4270ae835bb
      size: 7717
    outs:
    - path: data/processed/nuforc_reports.csv
      md5: d8e712aa3d37e2d3f71a634134067eec
      size: 208624171
